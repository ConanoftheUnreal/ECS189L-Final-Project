# Russell Reich

## Main Role: Procedural Generation

The main scene of the game, in which you fights monsters as you navigate around a castle, is entirely procedurally generated. This includes both the individual rooms themselves, as well as the layout of the entire level (e.g. how the rooms are connected). The implementation of the procedural generation involves extensive use of the Factory Design pattern, and is an entirely custom algorithm that is not based on any widely used procedural level generation algorithm, such as Perlin Noise or Wave Function Collapse. This was chosen because those algorithms tend to be better at creating environments that looks *natural*, but I wanted levels that looked like they were designed and built by intelligent beings.

But before we get to the actual procedural level generation algorithm, we need to introduce the [Room](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/main/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/Room.cs) class. The `Room` class is the class which contains all of the components of a room in a level, such as references to the actual Unity GameObjects for the room and its tilemaps, lists of enemy GameObjects which are spawned in the room, and public functions for revealing pathways in the room once the player defeats all of the enemies within it. The `Room` is the basic building block of a level.

Now, the first, and arguably most important, part of the procedural level generation is the [DungeonGenerator](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/main/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/DungeonGenerator.cs), which is itself an implementation of the [IRoomGenerator](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/main/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/IRoomGenerator.cs) interface. This is the Factory that has a `Generate()` method which returns an instance of the `Room` class. The basic idea of this algorithm is that rooms start out as hollow rectangles, and [additional rectangles are added to the interior of the room](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/DungeonGenerator.cs#L426C4-L516) in random positions and with random sizes. The number of, and maximum size of, these interior rectangles are parameters of any `IRoomGenerator`, along with the dimensions of the room, and are set at instantiation of the Factory. However, whenever a rectangle is added, [checks are performed](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/DungeonGenerator.cs#L756-L898) to ensure that the rectangle would not create a pathway in the room that is less than two tiles wide, and that it would not create an inaccesible section in the room. If the rectangle fails either of those conditions, it is discarded and a new rectangle is generated at a different location and with a different size. To ensure that the algorithm does not get stuck in a potentially infinite loop of generating rectangles which fail those conditions, a [contant value](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/DungeonGenerator.cs#L18) defines the maximum number of retries the algorithm gives to any particular rectangle. Once all of the rectangles are placed, the tile map [is iterated over several times](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/DungeonGenerator.cs#L900-L1177) in order to place wall tiles and border trim in the appropriate spots depending on a given tiles surroundings. Additionally, [possible locations for exit pathways from the room](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/DungeonGenerator.cs#L519-L753) are located, which themselves must adhere to several restrictions (most of which are to ensure that the revealing of those pathways will not cause any visual anomalies, such as creating walls that are too short and look awkward). Then, finally, [decorations, such as banners and torches,](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/DungeonGenerator.cs#L164-L330) are randomly thrown up on the walls of the room to give them a little more life.

Next, we have the [LevelLayoutGenerator](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/main/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/LevelLayoutGenerator.cs) which is a Factory which contains a `Generate()` method which returns a tree-structure of [LevelLayoutNodes](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/LevelLayoutGenerator.cs#L14-L89) that adheres to the rules set by the `maxDepth`, `maxRooms`, and `maxChildren` specified in the instantiation of the Factory. This class basically generates a tree that is no deeper than `maxDepth`, has no more nodes than `maxRooms`, and where each node has no more children than `maxChildren`. The "exit room" node is always placed at the maximum depth in the tree. However, within these constraints, the structure of the tree (more specifically an acyclic graph) is completely random.

And the final factory in the algorithm is the, very simple, [LevelGenerator](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/main/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/LevelGenerator.cs). The `LevelGenerator` is simply instantiated with an `IRoomGenerator` and a `LevelLayoutGenerator`, and uses the `IRoomGenerator` to generate a room at every node in a tree that is generated by the `LevelLayoutGenerator`. The rooms will be placed in the Unity hierarchy as children GameObjects of their respective parents, and a reference to the `Room` instance at the root of the tree will be returned by the LevelGenerators `Generate()` function.

To allow for reference to the `Room` that the player is currently in, a [LevelManager](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/main/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/LevelManager.cs) component is attached to the root room GameObject. The `LevelManager` keeps track of the [current node](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/LevelManager.cs#L7) in the tree that the player resides in, and is updated by [ExitManagers](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/main/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/ExitManager.cs) that are attached as components to GameObjects that reside at every exit from a room and utilize colliders to know when the player is attemping to leave a room. As the player leaves and enters rooms, [GameObjects which contitute rooms are enabled and disabled as you'd expect](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/Room.cs#L232-L270).

[Enemies are spawned in rooms quite simply](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/Room.cs#L127-L164), by just iterating over the room to identify all of the tiles which are not occupied by a wall, and by removing any such tiles which [are too close to the opening](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/blob/efdbc6babd30c1977519a158b6ddb377e5998599/Lucifer's%20Trials/Assets/Scripts/Procedural%20Generation/Room.cs#L33) in order to avoid the player being instantly ambushed when they enter a room. Then, tiles are just randomly sampled, without replacement, from the list of valid tiles and enemies are spawned at the locations of those tiles.

## Sub Role: Bug Fixer
Unfortunately, creating a procedural level generation algorithm ended up being a much larger endeavor than I had originally expected, and I ended up spending the vast majority of my development time on it. By the time I was happy with the state of the level generation, all of the other components of the game had already taken shape and were nearing a complete implementation. Desptite this, I was still very valuable in those final days at tracking down fixes for bugs that other members of the team did not have time to address (as they were too busy trying to get their features fully implemented).

Some of the more prominent bug fixes I pushed, outside of the realm of procedural generation, were:
- [Fixing visible gaps between tiles in our manually built treasure room](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/commit/995743a280e142ea63ed9a9a8f74c4dd542d8824)
- [Fixing player stats being reset between scenes](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/commit/05323609b2a4b30c851fd057fc3bf8ae6a083a81)
- [Fixing items not disappearing from the screen when the player leaves the room](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/commit/a3c7e6a1befef68bbf380e7b13016bee57ec4a76)
- [Fixing visual errors in the "Pre-Run" area](https://github.com/ConanoftheUnreal/ECS189L-Final-Project/commit/0dfcdbce1c72c9d26998900f7ff64493ee3bf1a9)

## Sub Role: Playtesting
I also assisted in finding playtesters for our game. In total, I got three people, outside of this class, to play the game and provide feedback. Two of them filled out written questionnaires for feedback, and one even recorded a video of himself playing the game so that we could see his first impressions. Although we were only able to get feedback the night before the game project was due, their criticisms would be extremely helpful for us if we decided to continue development of this game in the future.
